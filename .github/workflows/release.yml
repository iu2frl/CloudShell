name: Release

on:
  release:
    types: [published]

env:
  REGISTRY: ghcr.io

jobs:
  # ── Integration tests (must pass before any image is built) ─────────────────
  test:
    name: Integration Tests
    uses: ./.github/workflows/api-tests.yml

  # ── Backend: amd64 ──────────────────────────────────────────────────────────
  build-backend-amd64:
    name: Build backend (linux/amd64)
    runs-on: ubuntu-24.04
    needs: [test]
    permissions:
      contents: read
      packages: write

    outputs:
      digest: ${{ steps.push.outputs.digest }}
      image:  ${{ steps.image.outputs.name }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Compute lowercase image name
        id: image
        run: echo "name=$(echo '${{ env.REGISTRY }}/${{ github.repository }}-backend' | tr '[:upper:]' '[:lower:]')" >> "$GITHUB_OUTPUT"

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and push digest (amd64)
        id: push
        uses: docker/build-push-action@v6
        with:
          context: .
          file: Dockerfile.backend
          platforms: linux/amd64
          push: true
          build-args: APP_VERSION=${{ github.ref_name }}
          outputs: type=image,name=${{ steps.image.outputs.name }},push-by-digest=true,name-canonical=true
          cache-from: type=gha,scope=backend-amd64
          cache-to: type=gha,scope=backend-amd64,mode=max

  # ── Backend: arm64 ──────────────────────────────────────────────────────────
  build-backend-arm64:
    name: Build backend (linux/arm64)
    runs-on: ubuntu-24.04-arm
    needs: [test]
    permissions:
      contents: read
      packages: write

    outputs:
      digest: ${{ steps.push.outputs.digest }}
      image:  ${{ steps.image.outputs.name }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Compute lowercase image name
        id: image
        run: echo "name=$(echo '${{ env.REGISTRY }}/${{ github.repository }}-backend' | tr '[:upper:]' '[:lower:]')" >> "$GITHUB_OUTPUT"

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and push digest (arm64)
        id: push
        uses: docker/build-push-action@v6
        with:
          context: .
          file: Dockerfile.backend
          platforms: linux/arm64
          push: true
          build-args: APP_VERSION=${{ github.ref_name }}
          outputs: type=image,name=${{ steps.image.outputs.name }},push-by-digest=true,name-canonical=true
          cache-from: type=gha,scope=backend-arm64
          cache-to: type=gha,scope=backend-arm64,mode=max

  # ── Frontend: amd64 ─────────────────────────────────────────────────────────
  build-frontend-amd64:
    name: Build frontend (linux/amd64)
    runs-on: ubuntu-24.04
    needs: [test]
    permissions:
      contents: read
      packages: write

    outputs:
      digest: ${{ steps.push.outputs.digest }}
      image:  ${{ steps.image.outputs.name }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Compute lowercase image name
        id: image
        run: echo "name=$(echo '${{ env.REGISTRY }}/${{ github.repository }}-frontend' | tr '[:upper:]' '[:lower:]')" >> "$GITHUB_OUTPUT"

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and push digest (amd64)
        id: push
        uses: docker/build-push-action@v6
        with:
          context: .
          file: Dockerfile.frontend
          platforms: linux/amd64
          push: true
          outputs: type=image,name=${{ steps.image.outputs.name }},push-by-digest=true,name-canonical=true
          cache-from: type=gha,scope=frontend-amd64
          cache-to: type=gha,scope=frontend-amd64,mode=max

  # ── Frontend: arm64 ─────────────────────────────────────────────────────────
  build-frontend-arm64:
    name: Build frontend (linux/arm64)
    runs-on: ubuntu-24.04-arm
    needs: [test]
    permissions:
      contents: read
      packages: write

    outputs:
      digest: ${{ steps.push.outputs.digest }}
      image:  ${{ steps.image.outputs.name }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Compute lowercase image name
        id: image
        run: echo "name=$(echo '${{ env.REGISTRY }}/${{ github.repository }}-frontend' | tr '[:upper:]' '[:lower:]')" >> "$GITHUB_OUTPUT"

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and push digest (arm64)
        id: push
        uses: docker/build-push-action@v6
        with:
          context: .
          file: Dockerfile.frontend
          platforms: linux/arm64
          push: true
          outputs: type=image,name=${{ steps.image.outputs.name }},push-by-digest=true,name-canonical=true
          cache-from: type=gha,scope=frontend-arm64
          cache-to: type=gha,scope=frontend-arm64,mode=max

  # ── Merge backend digests into a multi-arch manifest ────────────────────────
  merge-backend:
    name: Publish backend multi-arch manifest
    runs-on: ubuntu-24.04
    needs: [build-backend-amd64, build-backend-arm64]
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Compute lowercase image name
        id: image
        run: echo "name=$(echo '${{ env.REGISTRY }}/${{ github.repository }}-backend' | tr '[:upper:]' '[:lower:]')" >> "$GITHUB_OUTPUT"

      - name: Compute image tags
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ steps.image.outputs.name }}
          tags: |
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=ref,event=tag
            type=raw,value=latest

      - name: Create multi-arch manifest and push all tags
        run: |
          TAGS=$(echo "${{ steps.meta.outputs.tags }}" | tr '\n' ' ')
          TAG_ARGS=""
          for tag in $TAGS; do TAG_ARGS="$TAG_ARGS --tag $tag"; done
          docker buildx imagetools create $TAG_ARGS \
            "${{ needs.build-backend-amd64.outputs.image }}@${{ needs.build-backend-amd64.outputs.digest }}" \
            "${{ needs.build-backend-arm64.outputs.image }}@${{ needs.build-backend-arm64.outputs.digest }}"

      - name: Inspect final manifest
        run: docker buildx imagetools inspect "${{ steps.image.outputs.name }}:${{ steps.meta.outputs.version }}"

  # ── Merge frontend digests into a multi-arch manifest ───────────────────────
  merge-frontend:
    name: Publish frontend multi-arch manifest
    runs-on: ubuntu-24.04
    needs: [build-frontend-amd64, build-frontend-arm64]
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Compute lowercase image name
        id: image
        run: echo "name=$(echo '${{ env.REGISTRY }}/${{ github.repository }}-frontend' | tr '[:upper:]' '[:lower:]')" >> "$GITHUB_OUTPUT"

      - name: Compute image tags
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ steps.image.outputs.name }}
          tags: |
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=ref,event=tag
            type=raw,value=latest

      - name: Create multi-arch manifest and push all tags
        run: |
          TAGS=$(echo "${{ steps.meta.outputs.tags }}" | tr '\n' ' ')
          TAG_ARGS=""
          for tag in $TAGS; do TAG_ARGS="$TAG_ARGS --tag $tag"; done
          docker buildx imagetools create $TAG_ARGS \
            "${{ needs.build-frontend-amd64.outputs.image }}@${{ needs.build-frontend-amd64.outputs.digest }}" \
            "${{ needs.build-frontend-arm64.outputs.image }}@${{ needs.build-frontend-arm64.outputs.digest }}"

      - name: Inspect final manifest
        run: docker buildx imagetools inspect "${{ steps.image.outputs.name }}:${{ steps.meta.outputs.version }}"
