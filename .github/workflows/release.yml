name: Release

on:
  release:
    types: [published]

env:
  REGISTRY: ghcr.io

jobs:
  # ── Integration tests (must pass before any image is built) ─────────────────
  test:
    name: Integration Tests
    uses: ./.github/workflows/api-tests.yml

  # ── Build amd64 ─────────────────────────────────────────────────────────────
  build-amd64:
    name: Build (linux/amd64)
    runs-on: ubuntu-24.04
    needs: [test]
    permissions:
      contents: read
      packages: write

    outputs:
      digest: ${{ steps.push.outputs.digest }}
      image: ${{ steps.image.outputs.name }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Compute lowercase image name
        id: image
        run: echo "name=$(echo '${{ env.REGISTRY }}/${{ github.repository }}' | tr '[:upper:]' '[:lower:]')" >> "$GITHUB_OUTPUT"

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and push digest (amd64)
        id: push
        uses: docker/build-push-action@v6
        with:
          context: .
          platforms: linux/amd64
          push: true
          outputs: type=image,name=${{ steps.image.outputs.name }},push-by-digest=true,name-canonical=true
          cache-from: type=gha,scope=amd64
          cache-to: type=gha,scope=amd64,mode=max

  # ── Build arm64 ─────────────────────────────────────────────────────────────
  build-arm64:
    name: Build (linux/arm64)
    runs-on: ubuntu-24.04-arm
    needs: [test]
    permissions:
      contents: read
      packages: write

    outputs:
      digest: ${{ steps.push.outputs.digest }}
      image: ${{ steps.image.outputs.name }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Compute lowercase image name
        id: image
        run: echo "name=$(echo '${{ env.REGISTRY }}/${{ github.repository }}' | tr '[:upper:]' '[:lower:]')" >> "$GITHUB_OUTPUT"

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and push digest (arm64)
        id: push
        uses: docker/build-push-action@v6
        with:
          context: .
          platforms: linux/arm64
          push: true
          outputs: type=image,name=${{ steps.image.outputs.name }},push-by-digest=true,name-canonical=true
          cache-from: type=gha,scope=arm64
          cache-to: type=gha,scope=arm64,mode=max

  # ── Merge digests into a multi-arch manifest list ───────────────────────────
  merge:
    name: Publish multi-arch manifest
    runs-on: ubuntu-24.04
    needs: [build-amd64, build-arm64]
    permissions:
      contents: read
      packages: write

    steps:
      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Compute lowercase image name
        id: image
        run: echo "name=$(echo '${{ env.REGISTRY }}/${{ github.repository }}' | tr '[:upper:]' '[:lower:]')" >> "$GITHUB_OUTPUT"

      - name: Compute image tags
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ steps.image.outputs.name }}
          tags: |
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=raw,value=latest

      - name: Create multi-arch manifest and push all tags
        run: |
          TAGS=$(echo "${{ steps.meta.outputs.tags }}" | tr '\n' ' ')
          TAG_ARGS=""
          for tag in $TAGS; do
            TAG_ARGS="$TAG_ARGS --tag $tag"
          done

          docker buildx imagetools create $TAG_ARGS \
            "${{ needs.build-amd64.outputs.image }}@${{ needs.build-amd64.outputs.digest }}" \
            "${{ needs.build-arm64.outputs.image }}@${{ needs.build-arm64.outputs.digest }}"

      - name: Inspect final manifest
        run: |
          docker buildx imagetools inspect \
            "${{ steps.image.outputs.name }}:${{ steps.meta.outputs.version }}"

