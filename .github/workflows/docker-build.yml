name: Docker Build (reusable)

on:
  workflow_call:

jobs:
  docker-build:
    name: Build Docker images and smoke-test stack
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build backend image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: Dockerfile.backend
          push: false
          tags: cloudshell-backend:ci
          cache-from: type=gha,scope=backend
          cache-to: type=gha,scope=backend,mode=max

      - name: Build frontend image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: Dockerfile.frontend
          push: false
          tags: cloudshell-frontend:ci
          cache-from: type=gha,scope=frontend
          cache-to: type=gha,scope=frontend,mode=max

      - name: Smoke-test stack with Docker Compose
        run: |
          # Override image names to use the ones we just built
          docker compose \
            -f docker-compose.yml \
            --env-file /dev/null \
            -p cloudshell-ci \
            up -d \
            --no-build \
            2>&1 || true

          # Start the stack using our CI images directly
          docker network create cloudshell-ci-internal 2>/dev/null || true

          docker run -d --name cs-backend-ci \
            --network cloudshell-ci-internal \
            --network-alias backend \
            -e SECRET_KEY=ci-test-secret \
            -e ADMIN_USER=admin \
            -e ADMIN_PASSWORD=admin \
            cloudshell-backend:ci

          docker run -d --name cs-frontend-ci \
            --network cloudshell-ci-internal \
            -p 8080:80 \
            cloudshell-frontend:ci

          echo "Waiting for backend to be healthy..."
          for i in $(seq 1 30); do
            STATUS=$(docker inspect --format='{{.State.Health.Status}}' cs-backend-ci 2>/dev/null || echo "starting")
            echo "  [$i] backend=$STATUS"
            if [ "$STATUS" = "healthy" ]; then break; fi
            sleep 2
          done

          echo "Waiting for frontend to be healthy..."
          for i in $(seq 1 20); do
            STATUS=$(docker inspect --format='{{.State.Health.Status}}' cs-frontend-ci 2>/dev/null || echo "starting")
            echo "  [$i] frontend=$STATUS"
            if [ "$STATUS" = "healthy" ]; then break; fi
            sleep 2
          done

          BACKEND_STATUS=$(docker inspect --format='{{.State.Health.Status}}' cs-backend-ci)
          FRONTEND_STATUS=$(docker inspect --format='{{.State.Health.Status}}' cs-frontend-ci)

          echo "Final backend status : $BACKEND_STATUS"
          echo "Final frontend status: $FRONTEND_STATUS"

          # Verify the frontend proxies the API correctly
          HTTP=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:8080/api/health)
          echo "Proxied /api/health HTTP status: $HTTP"

          docker stop cs-backend-ci cs-frontend-ci
          docker rm cs-backend-ci cs-frontend-ci
          docker network rm cloudshell-ci-internal

          [ "$BACKEND_STATUS"  = "healthy" ] || (echo "Backend never became healthy"  && exit 1)
          [ "$FRONTEND_STATUS" = "healthy" ] || (echo "Frontend never became healthy" && exit 1)
          [ "$HTTP" = "200" ]                || (echo "Nginx proxy to /api/health failed (HTTP $HTTP)" && exit 1)

          echo "Docker smoke test passed"
