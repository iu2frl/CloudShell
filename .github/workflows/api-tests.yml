name: API Integration Tests (reusable)

on:
  workflow_call:
    inputs:
      python-version:
        description: Python version to use
        type: string
        default: "3.12"
      node-version:
        description: Node.js version to use
        type: string
        default: "20"

jobs:
  api-tests:
    name: Backend CRUD smoke tests
    runs-on: ubuntu-latest

    env:
      DATA_DIR: /tmp/cloudshell-test
      SECRET_KEY: ci-test-secret
      ADMIN_USER: admin
      ADMIN_PASSWORD: admin
      TOKEN_TTL_HOURS: "1"

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # ── Python setup ────────────────────────────────────────────────────────
      - name: Set up Python ${{ inputs.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ inputs.python-version }}
          cache: pip

      - name: Install Python dependencies
        run: pip install -r requirements.txt

      # ── Node setup (build frontend so FastAPI can serve static files) ───────
      - name: Set up Node.js ${{ inputs.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ inputs.node-version }}
          cache: npm
          cache-dependency-path: frontend/package-lock.json

      - name: Install frontend dependencies
        working-directory: frontend
        run: npm ci --silent

      - name: Build frontend
        working-directory: frontend
        run: npm run build

      # ── Start backend ────────────────────────────────────────────────────────
      - name: Start backend server
        run: |
          python -m uvicorn backend.main:app --host 0.0.0.0 --port 8000 &
          echo "BACKEND_PID=$!" >> "$GITHUB_ENV"

      - name: Wait for backend to be ready
        run: |
          for i in $(seq 1 15); do
            if curl -sf http://localhost:8000/api/health > /dev/null; then
              echo "Backend is up after ${i}s"
              break
            fi
            echo "Waiting... ($i)"
            sleep 1
          done
          curl -sf http://localhost:8000/api/health

      # ── Auth tests ───────────────────────────────────────────────────────────
      - name: Test health endpoint
        run: |
          RESP=$(curl -sf http://localhost:8000/api/health)
          echo "$RESP"
          echo "$RESP" | python3 -c "
          import sys, json
          d = json.load(sys.stdin)
          assert d['status'] == 'ok', f'Expected ok, got {d}'
          assert d['version'] == '1.0.0', f'Unexpected version: {d[\"version\"]}'
          assert isinstance(d['uptime_seconds'], int), 'uptime_seconds must be int'
          assert d['uptime_seconds'] >= 0, 'uptime_seconds must be non-negative'
          print('Health OK')
          "

      - name: Test login with valid credentials
        run: |
          RESP=$(curl -sf -X POST http://localhost:8000/api/auth/token \
            -d "username=admin&password=admin" \
            -H "Content-Type: application/x-www-form-urlencoded")
          echo "$RESP"
          TOKEN=$(echo "$RESP" | python3 -c "
          import sys, json
          d = json.load(sys.stdin)
          assert 'access_token' in d, 'access_token missing'
          assert d['token_type'] == 'bearer', f'bad token_type: {d[\"token_type\"]}'
          assert 'expires_at' in d, 'expires_at missing from token response'
          print(d['access_token'])
          ")
          echo "TOKEN=${TOKEN}" >> "$GITHUB_ENV"
          echo "Login OK (token length: ${#TOKEN})"

      - name: Test login with wrong password returns 401
        run: |
          HTTP=$(curl -s -o /dev/null -w "%{http_code}" -X POST http://localhost:8000/api/auth/token \
            -d "username=admin&password=wrongpassword" \
            -H "Content-Type: application/x-www-form-urlencoded")
          echo "HTTP status: $HTTP"
          [ "$HTTP" = "401" ] && echo "Reject wrong password OK" || (echo "Expected 401, got $HTTP" && exit 1)

      - name: Test login with wrong username returns 401
        run: |
          HTTP=$(curl -s -o /dev/null -w "%{http_code}" -X POST http://localhost:8000/api/auth/token \
            -d "username=nobody&password=admin" \
            -H "Content-Type: application/x-www-form-urlencoded")
          echo "HTTP status: $HTTP"
          [ "$HTTP" = "401" ] && echo "Reject wrong username OK" || (echo "Expected 401, got $HTTP" && exit 1)

      - name: Test unauthenticated request returns 401
        run: |
          HTTP=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:8000/api/devices/)
          echo "HTTP status: $HTTP"
          [ "$HTTP" = "401" ] && echo "Unauthenticated rejected OK" || (echo "Expected 401, got $HTTP" && exit 1)

      # ── Device CRUD tests ────────────────────────────────────────────────────
      - name: Test list devices (empty)
        run: |
          RESP=$(curl -sf -H "Authorization: Bearer $TOKEN" http://localhost:8000/api/devices/)
          echo "$RESP"
          echo "$RESP" | python3 -c "
          import sys, json
          d = json.load(sys.stdin)
          assert d == [], f'Expected empty list, got {d}'
          print('✅ Empty device list OK')
          "

      - name: Test create device (password auth)
        run: |
          RESP=$(curl -sf -X POST http://localhost:8000/api/devices/ \
            -H "Authorization: Bearer $TOKEN" \
            -H "Content-Type: application/json" \
            -d '{
              "name": "Test Router",
              "hostname": "192.168.1.1",
              "port": 22,
              "username": "admin",
              "auth_type": "password",
              "password": "secret123"
            }')
          echo "$RESP"
          DEVICE_ID=$(echo "$RESP" | python3 -c "
          import sys, json
          d = json.load(sys.stdin)
          assert d['name'] == 'Test Router'
          assert d['hostname'] == '192.168.1.1'
          assert d['port'] == 22
          assert d['auth_type'] == 'password'
          assert 'encrypted_password' not in d, 'password must not be exposed in response'
          print(d['id'])
          ")
          echo "DEVICE_ID=${DEVICE_ID}" >> "$GITHUB_ENV"
          echo "Create device OK (id=$DEVICE_ID)"

      - name: Test create password-auth device without password returns 400
        run: |
          HTTP=$(curl -s -o /dev/null -w "%{http_code}" \
            -X POST http://localhost:8000/api/devices/ \
            -H "Authorization: Bearer $TOKEN" \
            -H "Content-Type: application/json" \
            -d '{"name":"bad","hostname":"1.2.3.4","port":22,"username":"u","auth_type":"password"}')
          echo "HTTP status: $HTTP"
          [ "$HTTP" = "400" ] && echo "Missing password -> 400 OK" || (echo "Expected 400, got $HTTP" && exit 1)

      - name: Test create key-auth device without private_key returns 400
        run: |
          HTTP=$(curl -s -o /dev/null -w "%{http_code}" \
            -X POST http://localhost:8000/api/devices/ \
            -H "Authorization: Bearer $TOKEN" \
            -H "Content-Type: application/json" \
            -d '{"name":"bad","hostname":"1.2.3.4","port":22,"username":"u","auth_type":"key"}')
          echo "HTTP status: $HTTP"
          [ "$HTTP" = "400" ] && echo "Missing private_key -> 400 OK" || (echo "Expected 400, got $HTTP" && exit 1)

      - name: Test get device by id
        run: |
          RESP=$(curl -sf -H "Authorization: Bearer $TOKEN" http://localhost:8000/api/devices/$DEVICE_ID)
          echo "$RESP"
          echo "$RESP" | python3 -c "
          import sys, json, os
          d = json.load(sys.stdin)
          assert str(d['id']) == os.environ['DEVICE_ID']
          assert d['name'] == 'Test Router'
          print('Get device OK')
          "

      - name: Test list devices (one item)
        run: |
          RESP=$(curl -sf -H "Authorization: Bearer $TOKEN" http://localhost:8000/api/devices/)
          echo "$RESP"
          echo "$RESP" | python3 -c "
          import sys, json
          d = json.load(sys.stdin)
          assert len(d) == 1, f'Expected 1 device, got {len(d)}'
          print('List one device OK')
          "

      - name: Test update device
        run: |
          RESP=$(curl -sf -X PUT http://localhost:8000/api/devices/$DEVICE_ID \
            -H "Authorization: Bearer $TOKEN" \
            -H "Content-Type: application/json" \
            -d '{"name": "Test Router (updated)", "port": 2222}')
          echo "$RESP"
          echo "$RESP" | python3 -c "
          import sys, json
          d = json.load(sys.stdin)
          assert d['name'] == 'Test Router (updated)', f'Name not updated: {d}'
          assert d['port'] == 2222, f'Port not updated: {d}'
          assert d['hostname'] == '192.168.1.1', 'Hostname should be unchanged'
          assert d['updated_at'] != d['created_at'], 'updated_at should differ from created_at'
          print('Update device OK')
          "

      - name: Test update non-existent device returns 404
        run: |
          HTTP=$(curl -s -o /dev/null -w "%{http_code}" \
            -X PUT http://localhost:8000/api/devices/99999 \
            -H "Authorization: Bearer $TOKEN" \
            -H "Content-Type: application/json" \
            -d '{"name": "ghost"}')
          echo "HTTP status: $HTTP"
          [ "$HTTP" = "404" ] && echo "Update non-existent device -> 404 OK" || (echo "Expected 404, got $HTTP" && exit 1)

      - name: Test delete device
        run: |
          HTTP=$(curl -s -o /dev/null -w "%{http_code}" -X DELETE \
            -H "Authorization: Bearer $TOKEN" \
            http://localhost:8000/api/devices/$DEVICE_ID)
          echo "HTTP status: $HTTP"
          [ "$HTTP" = "204" ] && echo "Delete device OK" || (echo "Expected 204, got $HTTP" && exit 1)

      - name: Test delete non-existent device returns 404
        run: |
          HTTP=$(curl -s -o /dev/null -w "%{http_code}" -X DELETE \
            -H "Authorization: Bearer $TOKEN" \
            http://localhost:8000/api/devices/99999)
          echo "HTTP status: $HTTP"
          [ "$HTTP" = "404" ] && echo "Delete non-existent device -> 404 OK" || (echo "Expected 404, got $HTTP" && exit 1)

      - name: Test list devices (empty after delete)
        run: |
          RESP=$(curl -sf -H "Authorization: Bearer $TOKEN" http://localhost:8000/api/devices/)
          echo "$RESP"
          echo "$RESP" | python3 -c "
          import sys, json
          d = json.load(sys.stdin)
          assert d == [], f'Expected empty list after delete, got {d}'
          print('Empty list after delete OK')
          "

      - name: Test get deleted device returns 404
        run: |
          HTTP=$(curl -s -o /dev/null -w "%{http_code}" \
            -H "Authorization: Bearer $TOKEN" \
            http://localhost:8000/api/devices/$DEVICE_ID)
          echo "HTTP status: $HTTP"
          [ "$HTTP" = "404" ] && echo "404 on deleted device OK" || (echo "Expected 404, got $HTTP" && exit 1)

      # ── Frontend build artefact ───────────────────────────────────────────────
      - name: Test backend serves frontend bundle
        run: |
          HTTP=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:8000/)
          [ "$HTTP" = "200" ] && echo "Frontend served OK" || (echo "Expected 200, got $HTTP" && exit 1)

      # ── SSH error handling ────────────────────────────────────────────────────
      - name: Test SSH session on non-existent device returns 404
        run: |
          HTTP=$(curl -s -o /dev/null -w "%{http_code}" -X POST \
            -H "Authorization: Bearer $TOKEN" \
            "http://localhost:8000/api/terminal/session/99999")
          echo "HTTP status: $HTTP"
          [ "$HTTP" = "404" ] && echo "Terminal session non-existent device -> 404 OK" || (echo "Expected 404, got $HTTP" && exit 1)

      - name: Test SSH to closed port returns 502
        run: |
          DEVICE=$(curl -sf -X POST http://localhost:8000/api/devices/ \
            -H "Authorization: Bearer $TOKEN" \
            -H "Content-Type: application/json" \
            -d '{
              "name": "Bad Port",
              "hostname": "127.0.0.1",
              "port": 19999,
              "username": "user",
              "auth_type": "password",
              "password": "pass"
            }')
          SSH_DEV_ID=$(echo "$DEVICE" | python3 -c "import sys,json; print(json.load(sys.stdin)['id'])")
          HTTP=$(curl -s -o /dev/null -w "%{http_code}" -X POST \
            -H "Authorization: Bearer $TOKEN" \
            "http://localhost:8000/api/terminal/session/${SSH_DEV_ID}")
          echo "HTTP: $HTTP"
          curl -sf -X DELETE -H "Authorization: Bearer $TOKEN" \
            "http://localhost:8000/api/devices/${SSH_DEV_ID}" || true
          [ "$HTTP" = "502" ] && echo "SSH connection refused -> 502 OK" \
            || (echo "Expected 502, got $HTTP" && exit 1)

      # ── SSH key auth tests ───────────────────────────────────────────────────
      - name: Test generate SSH key pair
        run: |
          KEYPAIR=$(curl -sf -X POST http://localhost:8000/api/keys/generate \
            -H "Authorization: Bearer $TOKEN")
          echo "$KEYPAIR" | python3 -c "
          import sys, json
          d = json.load(sys.stdin)
          assert d['private_key'].startswith('-----BEGIN OPENSSH PRIVATE KEY-----'), 'bad private_key'
          assert d['public_key'].startswith('ssh-rsa '), 'bad public_key'
          print('Key pair generation OK')
          "
          echo "KEYPAIR_PRIV=$(echo $KEYPAIR | python3 -c "import sys,json; print(json.load(sys.stdin)['private_key'])" | base64 -w0)" >> "$GITHUB_ENV"

      - name: Test generate SSH key pair requires auth
        run: |
          HTTP=$(curl -s -o /dev/null -w "%{http_code}" \
            -X POST http://localhost:8000/api/keys/generate)
          echo "HTTP status: $HTTP"
          [ "$HTTP" = "401" ] && echo "Unauthenticated key generate -> 401 OK" || (echo "Expected 401, got $HTTP" && exit 1)

      - name: Test create key-auth device
        run: |
          PRIV=$(echo "$KEYPAIR_PRIV" | base64 -d)
          RESP=$(python3 - <<PYEOF
          import urllib.request, json, os
          token = os.environ["TOKEN"]
          priv  = os.environ["KEYPAIR_PRIV"]
          import base64
          priv = base64.b64decode(priv).decode()
          payload = json.dumps({
              "name": "key-device", "hostname": "127.0.0.1", "port": 22,
              "username": "ci", "auth_type": "key", "private_key": priv
          }).encode()
          req = urllib.request.Request(
              "http://localhost:8000/api/devices/",
              data=payload,
              headers={"Authorization": f"Bearer {token}", "Content-Type": "application/json"},
              method="POST"
          )
          resp = urllib.request.urlopen(req)
          print(resp.read().decode())
          PYEOF
          )
          echo "$RESP"
          KEY_DEV_ID=$(echo "$RESP" | python3 -c "
          import sys, json
          d = json.load(sys.stdin)
          assert d['auth_type'] == 'key', 'auth_type must be key'
          assert d['key_filename'] is not None, 'key_filename must be set'
          assert d['key_filename'].endswith('.enc'), 'key file must be .enc'
          print(d['id'])
          ")
          KEY_FILENAME=$(echo "$RESP" | python3 -c "import sys,json; print(json.load(sys.stdin)['key_filename'])")
          echo "KEY_DEV_ID=${KEY_DEV_ID}" >> "$GITHUB_ENV"
          echo "KEY_FILENAME=${KEY_FILENAME}" >> "$GITHUB_ENV"
          echo "Key-auth device created OK (id=$KEY_DEV_ID, file=$KEY_FILENAME)"

      - name: Test encrypted key file exists, no plaintext .pem
        run: |
          [ -f "$DATA_DIR/keys/$KEY_FILENAME" ] \
            && echo ".enc key file exists OK" \
            || (echo ".enc file missing" && exit 1)
          ls "$DATA_DIR/keys/"*.pem 2>/dev/null \
            && (echo "Plaintext .pem should not exist" && exit 1) \
            || echo "No plaintext .pem OK"

      - name: Test update key-auth device rotates key file
        run: |
          # Generate a second key pair
          KEYPAIR2=$(curl -sf -X POST http://localhost:8000/api/keys/generate \
            -H "Authorization: Bearer $TOKEN")
          PRIV2_B64=$(echo "$KEYPAIR2" | python3 -c \
            "import sys,json,base64; print(base64.b64encode(json.load(sys.stdin)['private_key'].encode()).decode())")
          OLD_FILENAME="$KEY_FILENAME"

          # Update the device with the new key
          RESP=$(PRIV2_B64="$PRIV2_B64" python3 -c "
          import urllib.request, json, os, base64
          token  = os.environ['TOKEN']
          dev_id = os.environ['KEY_DEV_ID']
          priv2  = base64.b64decode(os.environ['PRIV2_B64']).decode()
          payload = json.dumps({'private_key': priv2}).encode()
          req = urllib.request.Request(
              f'http://localhost:8000/api/devices/{dev_id}',
              data=payload,
              headers={'Authorization': f'Bearer {token}', 'Content-Type': 'application/json'},
              method='PUT'
          )
          print(urllib.request.urlopen(req).read().decode())
          ")
          echo "$RESP"
          NEW_FILENAME=$(echo "$RESP" | python3 -c "import sys,json; print(json.load(sys.stdin)['key_filename'])")

          [ -f "$DATA_DIR/keys/$NEW_FILENAME" ] \
            && echo "Rotated .enc key file exists OK" \
            || (echo "New .enc file missing after key rotation" && exit 1)
          echo "KEY_FILENAME=${NEW_FILENAME}" >> "$GITHUB_ENV"
          echo "Key rotation OK (old=$OLD_FILENAME, new=$NEW_FILENAME)"

      - name: Test delete key-auth device removes key file
        run: |
          curl -sf -X DELETE -H "Authorization: Bearer $TOKEN" \
            "http://localhost:8000/api/devices/$KEY_DEV_ID"
          [ ! -f "$DATA_DIR/keys/$KEY_FILENAME" ] \
            && echo ".enc key removed on device delete OK" \
            || (echo ".enc still present after delete" && exit 1)

      # ── Auth / session tests (M5) ─────────────────────────────────────────
      - name: Test /auth/me returns username and expiry
        run: |
          ME=$(curl -sf http://localhost:8000/api/auth/me \
            -H "Authorization: Bearer $TOKEN")
          echo "$ME" | python3 -c "
          import sys, json
          d = json.load(sys.stdin)
          assert d['username'] == 'admin', f'bad username: {d}'
          assert 'expires_at' in d, 'expires_at missing'
          print('/me OK')
          "

      - name: Test token refresh issues new token and revokes old one
        run: |
          RESP=$(curl -sf -X POST http://localhost:8000/api/auth/refresh \
            -H "Authorization: Bearer $TOKEN")
          NEW_TOKEN=$(echo "$RESP" | python3 -c "import sys,json; print(json.load(sys.stdin)['access_token'])")
          # Old token must now be revoked
          HTTP=$(curl -s -o /dev/null -w "%{http_code}" \
            http://localhost:8000/api/auth/me -H "Authorization: Bearer $TOKEN")
          [ "$HTTP" = "401" ] \
            && echo "Old token revoked after refresh OK" \
            || (echo "Expected 401 for old token, got $HTTP" && exit 1)
          # New token must work
          curl -sf http://localhost:8000/api/auth/me \
            -H "Authorization: Bearer $NEW_TOKEN" > /dev/null
          echo "New token valid after refresh OK"
          echo "TOKEN=$NEW_TOKEN" >> "$GITHUB_ENV"

      - name: Test refresh with already-revoked token returns 401
        run: |
          # TOKEN was just replaced above; the old one is already revoked
          # Attempt to refresh the old (revoked) token again
          HTTP=$(curl -s -o /dev/null -w "%{http_code}" \
            -X POST http://localhost:8000/api/auth/refresh \
            -H "Authorization: Bearer $TOKEN")
          # TOKEN here is the NEW token; get the old one via a second refresh to test
          # Instead, log in fresh and immediately revoke via logout, then try refresh
          TEMP_TOKEN=$(curl -sf -X POST http://localhost:8000/api/auth/token \
            -d "username=admin&password=admin" \
            -H "Content-Type: application/x-www-form-urlencoded" \
            | python3 -c "import sys,json; print(json.load(sys.stdin)['access_token'])")
          # Logout revokes TEMP_TOKEN
          curl -sf -X POST http://localhost:8000/api/auth/logout \
            -H "Authorization: Bearer $TEMP_TOKEN" -o /dev/null
          # Refresh should now return 401
          HTTP2=$(curl -s -o /dev/null -w "%{http_code}" \
            -X POST http://localhost:8000/api/auth/refresh \
            -H "Authorization: Bearer $TEMP_TOKEN")
          [ "$HTTP2" = "401" ] \
            && echo "Refresh with revoked token -> 401 OK" \
            || (echo "Expected 401 for revoked token refresh, got $HTTP2" && exit 1)

      - name: Test change-password rejects wrong current password
        run: |
          HTTP=$(curl -s -o /dev/null -w "%{http_code}" \
            -X POST http://localhost:8000/api/auth/change-password \
            -H "Authorization: Bearer $TOKEN" \
            -H "Content-Type: application/json" \
            -d '{"current_password":"wrongpassword","new_password":"doesnotmatter99"}')
          [ "$HTTP" = "401" ] \
            && echo "Wrong current password -> 401 OK" \
            || (echo "Expected 401, got $HTTP" && exit 1)

      - name: Test change-password endpoint
        run: |
          HTTP=$(curl -s -o /dev/null -w "%{http_code}" \
            -X POST http://localhost:8000/api/auth/change-password \
            -H "Authorization: Bearer $TOKEN" \
            -H "Content-Type: application/json" \
            -d '{"current_password":"admin","new_password":"newpass99"}')
          [ "$HTTP" = "204" ] \
            && echo "change-password 204 OK" \
            || (echo "Expected 204, got $HTTP" && exit 1)
          # Old env-var password should now be rejected
          HTTP2=$(curl -s -o /dev/null -w "%{http_code}" \
            -X POST http://localhost:8000/api/auth/token \
            -d "username=admin&password=admin")
          [ "$HTTP2" = "401" ] \
            && echo "Old password rejected after change OK" \
            || (echo "Old password still accepted: $HTTP2" && exit 1)
          # Login with new password
          NEW_TOKEN=$(curl -sf -X POST http://localhost:8000/api/auth/token \
            -d "username=admin&password=newpass99" \
            | python3 -c "import sys,json; print(json.load(sys.stdin)['access_token'])")
          echo "TOKEN=$NEW_TOKEN" >> "$GITHUB_ENV"
          echo "Login with new password OK"

      - name: Test change-password rejects too-short new password
        run: |
          HTTP=$(curl -s -o /dev/null -w "%{http_code}" \
            -X POST http://localhost:8000/api/auth/change-password \
            -H "Authorization: Bearer $TOKEN" \
            -H "Content-Type: application/json" \
            -d '{"current_password":"newpass99","new_password":"short"}')
          [ "$HTTP" = "422" ] \
            && echo "Short password -> 422 OK" \
            || (echo "Expected 422, got $HTTP" && exit 1)

      - name: Test logout revokes token
        run: |
          curl -sf -X POST http://localhost:8000/api/auth/logout \
            -H "Authorization: Bearer $TOKEN" -o /dev/null
          HTTP=$(curl -s -o /dev/null -w "%{http_code}" \
            http://localhost:8000/api/auth/me \
            -H "Authorization: Bearer $TOKEN")
          [ "$HTTP" = "401" ] \
            && echo "Token revoked after logout -> 401 OK" \
            || (echo "Expected 401 after logout, got $HTTP" && exit 1)

      - name: Test logout is idempotent
        run: |
          # Logging out an already-revoked token must not error
          HTTP=$(curl -s -o /dev/null -w "%{http_code}" \
            -X POST http://localhost:8000/api/auth/logout \
            -H "Authorization: Bearer $TOKEN")
          [ "$HTTP" = "204" ] \
            && echo "Double logout -> 204 OK" \
            || (echo "Expected 204 on double logout, got $HTTP" && exit 1)

      # ── Teardown ─────────────────────────────────────────────────────────────
      - name: Stop backend server
        if: always()
        run: kill "$BACKEND_PID" 2>/dev/null || true