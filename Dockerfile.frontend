FROM node:20-slim AS build

WORKDIR /app/frontend

COPY frontend/package*.json ./
RUN npm ci --silent

COPY frontend/ ./
RUN DOCKER_BUILD=1 npm run build


FROM nginx:1.27-alpine

LABEL org.opencontainers.image.title="CloudShell Frontend" \
      org.opencontainers.image.description="Self-hosted web SSH gateway â€” Nginx reverse proxy + static UI" \
      org.opencontainers.image.licenses="MIT" \
      org.opencontainers.image.source="https://github.com/iu2frl/CloudShell"

# Copy the React build artefact
COPY --from=build /app/frontend/dist /usr/share/nginx/html

# Copy our Nginx config (replaces the default)
COPY nginx/default.conf /etc/nginx/conf.d/default.conf

EXPOSE 80

HEALTHCHECK --interval=30s --timeout=5s --start-period=5s --retries=3 \
    CMD wget -qO- http://localhost/api/health || exit 1
